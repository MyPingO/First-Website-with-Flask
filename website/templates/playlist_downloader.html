{% extends "blueprint.html" %}

{%block title%}Home Page{%endblock%}

{%block cssimports%}
<link rel="stylesheet" href="{{ url_for('static', filename='playlistdownloaderstyles.css') }}">
{%endblock%}

{%block scripts%}
<script type="text/javascript">
    window.onload = function () {
        const href = window.location.href;
        let fileName = undefined
        let allAlerts = []
        
        let socketid = undefined

        const progressBar = document.getElementById("progress-bar");
        const progress = document.getElementById("progress");
        const percentText = document.getElementById("percentText");
        const playlistForm = document.getElementById("playlistForm");
        const playlistInput = document.getElementById("playlistInput");
        playlistInput.focus();

        for (form of [...document.getElementsByClassName("redownload")]) {
            form.onsubmit = download;
        }

        socket.on("connect", function () {
            console.log("Connected to server");
            socket.connect();

            socketid = socket.id;
            console.log("ID: " + socketid);
        });
        socket.on("get id", function () {
            socket.emit("socket id", socket.id);
        });
        socket.on("zip update", function (percent) {
            console.log("Received message from server: " + percent);
            if (percent) {
                progressBar.style.width = percent + "%";
                percentText.innerHTML = Math.trunc(percent) + "%";
            }
        });
        socket.on("file name", function (name) {
            console.log("File name will be: " + name);
            fileName = name;
        });
        socket.on('disconnect', function () {
            console.log("Disconnected from server");
        });

        socket.on("alert", function (content) {
            allAlerts.push([content.message, content.category]);
        });

        playlistForm.onsubmit = function (event) {
            event.preventDefault();
            let formData = new FormData(playlistForm);
            fetch("/download/" + socket.id,{
                method: playlistForm.method,
                body: formData
            })
            .then((response) => {
                //check if response header entries contains an attachment content-disposition
                if (fileName != undefined) {
                    //if it is, then download the file
                    response.blob().then((data) => {
                        let a = document.createElement("a");
                        a.href = window.URL.createObjectURL(data);
                        a.download = fileName;
                        a.click();
                        fileName = undefined;
                        //set progress bar back to 0% after 1 second
                        setTimeout(function () {
                            progressBar.style.width = "0%";
                            percentText.innerHTML = "";
                        }, 1000);
                    });
                }
                //display all flash messages if there are any
                displayAlerts(allAlerts);
                allAlerts = []
            })
        };
    }
    function download(event) {
        event.preventDefault();
        let formData = new FormData(event.target);
        console.log("Form data: " + formData);
        fetch("/download/" + socket.id, {
            method: event.target.method,
            body: formData
        })
        .then((response) => {
            return response.blob();
        })
        .then((data) => {
            var a = document.createElement("a");
            a.href = window.URL.createObjectURL(data);
            a.download = fileName;
            a.click();

        });
    };
    function displayAlerts(allAlerts) {
        let alerts = document.getElementById("alerts");
        alerts.innerHTML = "";
        for (let flashData of allAlerts) {
            let message = flashData[0];
            let category = flashData[1];
            let alertType = category == "error" ? "alert-danger" : "alert-success";
            let flashMessageDiv = document.createElement("div");
            flashMessageDiv.className = `alert ${alertType} alter-dismissable fade show`;
            flashMessageDiv.innerHTML = message;
            flashMessageDiv.setAttribute("role", "alert");
            flashMessageDiv.style = "width: 37vw; min-width: 325px; margin: auto; position: relative; padding-right: 3.25rem;";

            let closeButton = document.createElement("button");
            closeButton.type = "button";
            closeButton.className = "close";
            closeButton.style = "position: absolute; right: 1rem; top: .75rem; margin-left: 10px;"
            closeButton.setAttribute("data-dismiss", "alert");
            closeButton.setAttribute("aria-label", "Close");

            let i = document.createElement("i");
            i.className = "bi bi-x-circle";

            closeButton.appendChild(i);
            flashMessageDiv.appendChild(closeButton);
            flashMessageDiv.appendChild(document.createElement("br"));
            alerts.appendChild(flashMessageDiv);
        }
    }
</script>
{%endblock%}

{%block content%}

<div class = "alerts" id = "alerts">

</div>

<form action="/download" id="playlistForm" method="POST">
    <div class="formGroup">
        <label for="ytplaylist">
            <span style="width: 37vw; font-size: calc(.65rem + 2vw);">Enter YouTube Playlist/Video Link Here</span>
        </label>
        <div class="inputs">
            <div class="formInput position-relative playlistForm">
                <input class = "form-control playlistInput" id="playlistInput" type="text" class="form-control" name="url">
                <button class="btn btn-primary btn-sm position-absolute searchButton" type="submit" value="Search">Search</button>
            </div>
        </div>
    </div>
    <div class="progress position-relative download" id="progress" style="text-align: center;">
        <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0"
            aria-valuemin="0" aria-valuemax="100">
            <div class="justify-content-center d-flex position-absolute w-100" id = "percentText"></div>
        </div>
    </div>
    <div>
        <div class="rangeSettings" style="padding-top: 20px; padding-right: 20px; text-align: center;">
            <div style="padding-left: 20px;">
                <label for="Ranges" style="text-align: center;">
                    <h4>Specify Range (Inclusive)</h4>
                </label>
            </div>
            <ul class="rangeSettings"
                style="list-style:none; display: flex; flex-wrap: wrap; justify-content: center; padding-right: 20px">
                <li class="rangeListItem" style="min-width: 325px; width: 23vw; max-width: 25vw;">
                    <!--TODO: change min width according to screensize of mobile device-->
                    <div style="white-space: nowrap; text-align: center;">Start from playlist video (URL):</div>
                    <input class="form-control" type="text" name="start_video"
                        placeholder="https://www.youtube.com/watch?v=example123" style="text-align:center;">
                </li>
                <li class="rangeListItem" style="min-width: 325px; width: 23vw; max-width: 25vw;">
                    <div style="white-space: nowrap; text-align: center;">End at playlist video (URL):</div>
                    <input class="form-control" type="text" name="end_video"
                        placeholder="https://www.youtube.com/watch?v=example123" style="text-align:center;">
                </li>
            </ul>
        </div>
    </div>
</form>
{% if user.links %}
<div class="previousDownloadsList" style="padding-left:1vw; padding-top: 20px;">
    <div class="downloadsListDiv" style="display: flex; justify-content: center;">
        <ul class="list-group downloadsList" style="max-width: fit-content; padding-right: 1vw;">
            <label for="PreviousDownloads" style="text-align: center;">
                <h4>Previous Downloads</h4>
            </label>
            {% for youtube_link in user.links|reverse %}
            <li class="list-group-item">
                <div style="text-align: center;">
                    <strong>{{youtube_link.title}}</strong> <br>
                    <a href="{{ youtube_link.link }}" target="_blank">
                        {{ youtube_link.link }}
                    </a>
                    <div style="padding-top: 1px; display: flex; justify-content: center;">
                        Date: {{youtube_link.date_added}}
                        <!-- TODO Fix button position when in form -->
                        <form class="redownload" action="/download" method="POST" style = "margin-left: 5px;">
                            <input type="hidden" name="url" value="{{youtube_link.link}}">
                            <button type="submit" title="Download Again!"
                                style="font-size: 13px; text-align: center; padding: 0px 3px 0px 3px; border-width: 1px;">
                                Download Again!
                            </button>
                        </form>
                        <br>
                    </div>
                    {% if youtube_link.thumbnail_link %}
                    <a href="{{ youtube_link.thumbnail_link }}" target="_blank" title="Video Thumbnail">
                        <img class="thumbnail" src="{{ youtube_link.thumbnail_link }}" alt="Video Thumbnail"
                            style="width: 100%; height: 75%; margin-top: 10px;">
                    </a>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}


{%endblock%}